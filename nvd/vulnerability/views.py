from django.contrib.postgres.search import SearchVector
from rest_framework import status
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response

from nvd.vulnerability.models import Vulnerability


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def search_vulnerability(request, query):
    results = (Vulnerability.objects.annotate(
        search=SearchVector("cve_id", "description", "impact_score", "published_date"), )
               .filter(search=query))
    return Response({"results": results.values()}, status=status.HTTP_200_OK)


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def recent_vulnerabilities(request):
    date = request.GET.get('year', '')
    results = Vulnerability.objects.filter(published_date__gte=date)
    return Response({"results": results.values()}, status=status.HTTP_200_OK)
